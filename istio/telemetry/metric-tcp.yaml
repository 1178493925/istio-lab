apiVersion: config.istio.io/v1alpha2
kind: metric
metadata:
  name: tcpsentbytes
  namespace: default
spec:
  value: connection.sent.bytes | 0
  dimensions:
    source_service: source.workload.name | "unknown"
    source_version: source.labels["version"] | "unknown"
    destination_service: destination.workload.name | "unknown"
    destination_version: destination.labels["version"] | "unknown"
  monitoredResourceType: '"UNSPECIFIED"'
---
apiVersion: config.istio.io/v1alpha2
kind: metric
metadata:
  name: tcpreceivedbytes
  namespace: default
spec:
  value: connection.received.bytes | 0
  dimensions:
    source_service: source.workload.name | "unknown"
    source_version: source.labels["version"] | "unknown"
    destination_service: destination.workload.name | "unknown"
    destination_version: destination.labels["version"] | "unknown"
  monitoredResourceType: '"UNSPECIFIED"'
---
apiVersion: config.istio.io/v1alpha2
kind: prometheus
metadata:
  name: tcphandler
  namespace: default
spec:
  metrics:
  - name: tcp_sent_bytes
    instance_name: tcpsentbytes.metric.default
    kind: COUNTER
    label_names:
    - source_service
    - source_version
    - destination_service
    - destination_version
  - name: tcp_received_bytes
    instance_name: tcpreceivedbytes.metric.default
    kind: COUNTER
    label_names:
    - source_service
    - source_version
    - destination_service
    - destination_version
---
apiVersion: config.istio.io/v1alpha2
kind: rule
metadata:
  name: tcp-sent-received-bytes
  namespace: default
spec:
  match: context.protocol == "tcp"
         && destination.service == "redis.default.svc.cluster.local"
  actions:
  - handler: tcphandler.prometheus
    instances:
    - tcpreceivedbytes.metric
    - tcpsentbytes.metric
